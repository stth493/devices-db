{% extends "base.html" %}

{% block title %}Dashboard - Devices Database{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-tachometer-alt me-2"></i>Devices Dashboard</h2>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2"></i>Refresh Data
            </button>
        </div>

        {% if devices %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Devices Data ({{ devices|length }} records)</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="nodeSearch" class="form-label">Search by Node:</label>
                        <input type="text" id="nodeSearch" class="form-control" placeholder="Enter node name...">
                    </div>
                    <div class="col-md-6">
                        <label for="ipSearch" class="form-label">Search by IP Address:</label>
                        <input type="text" id="ipSearch" class="form-control" placeholder="Enter IP address...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="devicesTable">
                        <thead class="table-dark">
                            <tr>
                                {% for key in devices[0].keys() %}
                                {% if key not in ['pop', 'snmpVersion', 'communityRo'] %}
                                <th>{{ key }}</th>
                                {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            {% for device in devices %}
                            <tr style="display: none;" data-node="{{ device.get('node', '') | lower }}" data-ip="{{ device.get('loopbackIp', '') }}">
                                {% for key, value in device.items() %}
                                {% if key not in ['pop', 'snmpVersion', 'communityRo'] %}
                                <td>{{ value if value is not none else '-' }}</td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="noResults" class="alert alert-info" style="display: none;">
                    <i class="fas fa-search me-2"></i>Enter search criteria above to view device data.
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>No Data Available</h5>
            <p class="mb-0">The devices.xlsx file could not be loaded or contains no data. Please check if the file exists and is properly formatted.</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-primary">{{ devices|length }}</h3>
                            <p class="text-muted">Total Devices</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 class="text-success">{{ (devices[0].keys()|list|length - 3) if devices else 0 }}</h3>
                            <p class="text-muted">Data Fields</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            {% set online_count = devices|selectattr('Status', 'equalto', 'On-line')|list|length if devices else 0 %}
                            <h3 class="text-success">{{ online_count }}</h3>
                            <p class="text-muted">On-line</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            {% set offline_count = devices|selectattr('Status', 'equalto', 'Off-line')|list|length if devices else 0 %}
                            {% if offline_count == 0 and online_count > 0 %}
                                {% set offline_count = (devices|length) - online_count %}
                            {% endif %}
                            <h3 class="text-danger">{{ offline_count }}</h3>
                            <p class="text-muted">Off-line</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshData() {
    location.reload();
}

document.addEventListener('DOMContentLoaded', function() {
    const nodeSearch = document.getElementById('nodeSearch');
    const ipSearch = document.getElementById('ipSearch');
    const tableBody = document.getElementById('tableBody');
    const noResults = document.getElementById('noResults');
    
    if (nodeSearch && ipSearch && tableBody) {
        // Show initial message
        noResults.style.display = 'block';
        
        function performSearch() {
            const nodeValue = nodeSearch.value.toLowerCase().trim();
            const ipValue = ipSearch.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visibleCount = 0;
            
            // If both search fields are empty, hide all rows and show message
            if (!nodeValue && !ipValue) {
                rows.forEach(row => {
                    row.style.display = 'none';
                });
                noResults.style.display = 'block';
                return;
            }
            
            // Hide the no results message
            noResults.style.display = 'none';
            
            rows.forEach(row => {
                const nodeData = row.getAttribute('data-node') || '';
                const ipData = row.getAttribute('data-ip') || '';
                
                let showRow = true;
                
                // Check node criteria
                if (nodeValue && !nodeData.includes(nodeValue)) {
                    showRow = false;
                }
                
                // Check IP criteria
                if (ipValue && !ipData.toLowerCase().includes(ipValue)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            // If no rows match, show a different message
            if (visibleCount === 0) {
                const noMatchMessage = document.createElement('div');
                noMatchMessage.className = 'alert alert-warning';
                noMatchMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>No devices match your search criteria.';
                noMatchMessage.id = 'noMatchMessage';
                
                // Remove existing no match message
                const existingMessage = document.getElementById('noMatchMessage');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Add new message after the table
                tableBody.closest('.table-responsive').after(noMatchMessage);
            } else {
                // Remove no match message if it exists
                const existingMessage = document.getElementById('noMatchMessage');
                if (existingMessage) {
                    existingMessage.remove();
                }
            }
        }
        
        // Add event listeners
        nodeSearch.addEventListener('input', performSearch);
        ipSearch.addEventListener('input', performSearch);
    }
});
</script>
{% endblock %}